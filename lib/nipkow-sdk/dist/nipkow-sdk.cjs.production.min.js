"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t=e(require("https")),r=e(require("axios")),n=require("bitcoinjs-lib"),o=e(require("crypto-js/aes")),i=e(require("coinselect")),u=e(require("faker")),s=require("bip39"),c=require("lodash"),a=require("date-fns"),f=e(require("cbor-js")),d=e(require("pouchdb-browser")),h=e(require("pouchdb-adapter-memory")),p=e(require("pouchdb-find")),l=e(require("crypto-js")),m=e(require("qs")),v=e(require("crypto-js/sha256")),P={BITCOIN_SV:{bip32:{public:76067358,private:76066276},bech32:"",messagePrefix:"unused",pubKeyHash:0,scriptHash:5,wif:128},BITCOIN_SV_REGTEST:{bip32:{public:70617039,private:70615956},bech32:"bcrt",messagePrefix:"Bitcoin Signed Message:\n",pubKeyHash:111,scriptHash:196,wif:239,p2wpkh:{baseNetwork:"regtest",messagePrefix:"Bitcoin Signed Message:\n",bech32:"bcrt",bip32:{public:73342198,private:73341116},pubKeyHash:111,scriptHash:196,wif:239},p2wpkhInP2sh:{baseNetwork:"regtest",messagePrefix:"Bitcoin Signed Message:\n",bech32:"bcrt",bip32:{public:71979618,private:71978536},pubKeyHash:111,scriptHash:196,wif:239},p2wsh:{baseNetwork:"regtest",messagePrefix:"Bitcoin Signed Message:\n",bech32:"bcrt",bip32:{public:39277699,private:39276616},pubKeyHash:111,scriptHash:196,wif:239},p2wshInP2sh:{baseNetwork:"regtest",messagePrefix:"Bitcoin Signed Message:\n",bech32:"bcrt",bip32:{public:37915119,private:37914037},pubKeyHash:111,scriptHash:196,wif:239}},BITCOIN_SV_TESTNET:{bip32:{public:70617039,private:70615956},bech32:"tb",messagePrefix:"Bitcoin Signed Message:\n",pubKeyHash:111,scriptHash:196,wif:239,p2wpkh:{baseNetwork:"testnet",messagePrefix:"Bitcoin Signed Message:\n",bech32:"tb",bip32:{public:73342198,private:73341116},pubKeyHash:111,scriptHash:196,wif:239},p2wsh:{baseNetwork:"testnet",messagePrefix:"Bitcoin Signed Message:\n",bech32:"tb",bip32:{public:39277699,private:39276616},pubKeyHash:111,scriptHash:196,wif:239},p2wpkhInP2sh:{baseNetwork:"testnet",messagePrefix:"Bitcoin Signed Message:\n",bech32:"tb",bip32:{public:71979618,private:71978536},pubKeyHash:111,scriptHash:196,wif:239},p2wshInP2sh:{baseNetwork:"testnet",messagePrefix:"Bitcoin Signed Message:\n",bech32:"tb",bip32:{public:37915119,private:37914037},pubKeyHash:111,scriptHash:196,wif:239}}},y={__proto__:null,default:P},g={BITCOIN_SV:{BIP32:{derivationPath:"m/0"},BIP44:{purpose:44,coin:236,account:0,change:0,derivationPath:"m/44'/236'/0'/0",nUTXODerivationPath:"m/44'/236'/1'/0"}},BITCOIN_SV_TESTNET:{BIP32:{derivationPath:"m/0"},BIP44:{purpose:44,coin:1,account:0,change:0,derivationPath:"m/44/1/0/0",nUTXODerivationPath:"m/44/1/1/0"}},BITCOIN_SV_REGTEST:{BIP32:{derivationPath:"m/0"},BIP44:{purpose:44,coin:1,account:0,change:0,derivationPath:"m/44/1/0/0",nUTXODerivationPath:"m/44/1/1/0"}}},x={__proto__:null,default:g};const T=function(){function e(){}return e.prototype.then=function(t,r){const n=new e,o=this.s;if(o){const e=1&o?t:r;if(e){try{I(n,1,e(this.v))}catch(e){I(n,2,e)}return n}return this}return this.o=function(e){try{const o=e.v;1&e.s?I(n,1,t?t(o):o):r?I(n,1,r(o)):I(n,2,o)}catch(e){I(n,2,e)}},n},e}();function I(e,t,r){if(!e.s){if(r instanceof T){if(!r.s)return void(r.o=I.bind(null,e,t));1&t&&(t=r.s),r=r.v}if(r&&r.then)return void r.then(I.bind(null,e,t),I.bind(null,e,2));e.s=t,e.v=r;const n=e.o;n&&n(e)}}function _(e){return e instanceof T&&1&e.s}function w(e,t,r){var n,o,i=-1;return function u(s){try{for(;++i<e.length&&(!r||!r());)if((s=t(i))&&s.then){if(!_(s))return void s.then(u,o||(o=I.bind(null,n=new T,2)));s=s.v}n?I(n,1,s):n=s}catch(e){I(n||(n=new T),2,e)}}(),n}function b(e,t){try{var r=e()}catch(e){return t(e)}return r&&r.then?r.then(void 0,t):r}"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var S,O=function(e,t){try{return Promise.resolve(b((function(){return Promise.resolve(S.get(e,t))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},E=function(e,t,r){try{return Promise.resolve(b((function(){return Promise.resolve(S.post(e,t,r))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},B=function(e,t,r){try{return Promise.resolve(b((function(){return Promise.resolve(S.put(e,t,r))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},k=function(e,t){try{return Promise.resolve(b((function(){return Promise.resolve(S.delete(e,t))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},N={__proto__:null,init:function(e,n){(S=r.create({baseURL:"https://"+e+":"+n+"/v1",httpsAgent:new t.Agent({rejectUnauthorized:!1}),headers:{"Content-Type":"application/json"}})).interceptors.request.use((function(e){var t=localStorage.getItem("sessionKey");return e.headers.Authorization=t?"Bearer "+t:"",e}),(function(e){return console.log(e),Promise.reject(e)})),S.interceptors.response.use((function(e){return e}),(function(e){try{return Promise.resolve(e&&e.response&&403===e.response.status?b((function(){var e=localStorage.getItem("userName"),t=localStorage.getItem("password");return Promise.resolve(E("auth",{userName:e,password:t})).then((function(e){var t=e.data.auth.sessionKey;if(!t)throw new Error("Invalid sessionKey");localStorage.setItem("sessionKey",t),Promise.resolve()}))}),(function(e){return Promise.reject(e)})):new Promise((function(t,r){r(e)})))}catch(e){return Promise.reject(e)}}))},get:O,post:E,put:B,deleteR:k};function j(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function K(e,t,r){return t&&j(e.prototype,t),r&&j(e,r),e}function U(){return(U=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}var C=function(){function e(){}return K(e,[{key:"version",get:function(){return this._version},set:function(e){this._version=e}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"action",get:function(){return this._action},set:function(e){this._action=e}}]),e}(),H=function(){function e(){}return K(e,[{key:"producerInput",get:function(){return this._producerInput},set:function(e){this._producerInput=e}},{key:"producerOutput",get:function(){return this._producerOutput},set:function(e){this._producerOutput=e}},{key:"pOwnerOutput",get:function(){return this._pOwnerOutput},set:function(e){this._pOwnerOutput=e}},{key:"extensions",get:function(){return this._extensions},set:function(e){this._extensions=e}}]),e}(),A=function(){function e(){}return K(e,[{key:"ownerInput",get:function(){return this._ownerInput},set:function(e){this._ownerInput=e}},{key:"ownerOutput",get:function(){return this._ownerOutput},set:function(e){this._ownerOutput=e}},{key:"oProxyProviders",get:function(){return this._oProxyProviders},set:function(e){this._oProxyProviders=e}}]),e}(),D=function(){function e(){}return K(e,[{key:"index",get:function(){return this._index},set:function(e){this._index=e}}]),e}(),R=function(){function e(){}return K(e,[{key:"producer",get:function(){return this._producer},set:function(e){this._producer=e}},{key:"pVendorEndpoint",get:function(){return this._pVendorEndpoint},set:function(e){this._pVendorEndpoint=e}}]),e}(),X=function(){function e(){}return K(e,[{key:"owner",get:function(){return this._owner},set:function(e){this._owner=e}},{key:"oVendorEndpoint",get:function(){return this._oVendorEndpoint},set:function(e){this._oVendorEndpoint=e}}]),e}(),V=function(){function e(){}return K(e,[{key:"ownerOutputEx",get:function(){return this._ownerOutputEx},set:function(e){this._ownerOutputEx=e}},{key:"codePoint",get:function(){return this._codePoint},set:function(e){this._codePoint=e}}]),e}(),G=function(){function e(){}return K(e,[{key:"producerOutputEx",get:function(){return this._producerOutputEx},set:function(e){this._producerOutputEx=e}},{key:"codePoint",get:function(){return this._codePoint},set:function(e){this._codePoint=e}}]),e}(),q=function(){function e(){}return K(e,[{key:"protocol",get:function(){return this._protocol},set:function(e){this._protocol=e}},{key:"uri",get:function(){return this._uri},set:function(e){this._uri=e}}]),e}(),M=function(){function e(){}return K(e,[{key:"service",get:function(){return this._service},set:function(e){this._service=e}},{key:"mode",get:function(){return this._mode},set:function(e){this._mode=e}},{key:"endpoint",get:function(){return this._endpoint},set:function(e){this._endpoint=e}},{key:"registration",get:function(){return this._registration},set:function(e){this._registration=e}}]),e}(),z=function(){function e(){}return K(e,[{key:"addressCommitment",get:function(){return this._addressCommitment},set:function(e){this._addressCommitment=e}},{key:"utxoCommitment",get:function(){return this._utxoCommitment},set:function(e){this._utxoCommitment=e}},{key:"signature",get:function(){return this._signature},set:function(e){this._signature=e}},{key:"expiry",get:function(){return this._expiry},set:function(e){this._expiry=e}}]),e}();function F(e){var t,r,n=new C;return e.length>=2&&(n.version=e[1],n.name=e[2],4===e[3].length&&(n.action=(t=e[3],(r=new A).ownerInput=$(t[1]),r.ownerOutput=W(t[2]),r.oProxyProviders=t[3].map((function(e){var t=new M;return t.service=e[1],t.mode=e[2],t.endpoint=Y(e[3]),t.registration=function(e){var t=new z;return t.addressCommitment=e[1],t.utxoCommitment=e[2],t.signature=e[3],t.expiry=e[4],t}(e[4]),t})),r)),5===e[3].length&&(n.action=function(e){var t=new H;return t.producerInput=$(e[1]),t.producerOutput=Q(e[2]),e[3].length>0&&(t.pOwnerOutput=function(e){var t=new X;return t.owner=$(e[1]),t.oVendorEndpoint=L(e[2]),t}(e[3])),t.extensions=function(e){return e.map((function(e){return 0===e[0]?function(e){var t=new V;return t.ownerOutputEx=W(e[1]),t.codePoint=e[2],t}(e):function(e){var t=new G;return t.producerOutputEx=Q(e[1]),t.codePoint=e[2],t}(e)}))}(e[4]),t}(e[3]))),n}function $(e){var t=new D;return t.index=e[1],t}function W(e){var t=new X;return t.owner=$(e[1]),t.oVendorEndpoint=L(e[2]),t}function L(e){return Y(e[0])}function Q(e){var t=new R;return t.producer=$(e[1]),t.pVendorEndpoint=Y(e[2][0]),t}function Y(e){var t=new q;return t.protocol=e[1],t.uri=e[2],t}function J(e){var t=e.substring(36),r=parseInt(t.substring(0,2),16);if(r<=75)return t.substring(2);if(76===r)return t.substring(4);if(77===r)return t.substring(6);if(78===r)return t.substring(10);if(153===r)throw new Error("Incorrect data");throw new Error("Incorrect data")}function Z(e){var t=J(e),r=Buffer.from(t,"hex"),n=r.buffer.slice(r.byteOffset,r.byteOffset+r.byteLength);try{return f.decode(n)}catch(e){throw console.log(e),e}}var ee,te,re,ne={__proto__:null,ProducerAction:H,OwnerAction:A,OwnerExtension:V,ProducerExtension:G,getAllegoryType:F,removeOpReturn:J,decodeCBORData:Z};d.plugin(h),d.plugin(p);var oe=function(e,t){try{return Promise.resolve(e.get(t))}catch(e){return Promise.reject(e)}},ie=function(e,t,r){try{return Promise.resolve(e.get(t)).then((function(t){for(var n in r)t[n]=r[n];return Promise.resolve(e.put(t)).then((function(){}))}))}catch(e){return Promise.reject(e)}},ue=function(e){try{return te=new d(""+e,{revs_limit:1,auto_compaction:!0}),re=new d("credentials",{revs_limit:1,auto_compaction:!0}),Promise.resolve(re.bulkDocs([{_id:"bip32ExtendedKey",value:null},{_id:"nUTXOExtendedKey",value:null}])).then((function(){}))}catch(e){return Promise.reject(e)}},se=function(e,t){try{var r={cryptedMnemonic:e,name:t},n=b((function(){return Promise.resolve(ee.get("profiles")).then((function(e){var t=e&&e.value&&e.value instanceof Array?(e.value=[].concat(e.value,[r]),Promise.resolve(ee.put(e)).then((function(){}))):Promise.resolve(ee.put({_id:"profiles",value:[r]})).then((function(){}));if(t&&t.then)return t.then((function(){}))}))}),(function(){return Promise.resolve(ee.put({_id:"profiles",value:[r]})).then((function(){}))}));return Promise.resolve(n&&n.then?n.then((function(){})):void 0)}catch(e){return Promise.reject(e)}},ce=function(e,t){try{return Promise.resolve(b((function(){return Promise.resolve(ee.get("profiles",{revs:!0})).then((function(r){var n=r.value.findIndex((function(t){return t.name===e})),o=r.value;return o[n].name=t,Promise.resolve(ee.put({_id:"profiles",_rev:r._rev,value:o})).then((function(){}))}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},ae=function(){return Promise.resolve(b((function(){return ee=new d("Profiles",{revs_limit:1,auto_compaction:!0}),Promise.resolve(ee.get("profiles")).then((function(e){return e&&e.value&&e.value instanceof Array?e.value.map((function(e){return e})):[]}))}),(function(){return[]})))},fe=function(e,t){try{return Promise.resolve(ae()).then((function(r){var n=r.find((function(t){return t.name===e}));if(n){var i=o.decrypt(n.cryptedMnemonic,t).toString(l.enc.Utf8);if(i)return i;throw new Error("Login error")}throw new Error("Account Doesn't exist")}))}catch(e){return Promise.reject(e)}},de=function(){try{return Promise.resolve(oe(re,"bip32ExtendedKey")).then((function(e){return e.value}))}catch(e){return Promise.reject(e)}},he=function(e){return Promise.resolve(ie(re,"bip32ExtendedKey",{value:e}))},pe=function(){try{return Promise.resolve(oe(re,"nUTXOExtendedKey")).then((function(e){return e.value}))}catch(e){return Promise.reject(e)}},le=function(e){return Promise.resolve(ie(re,"nUTXOExtendedKey",{value:e}))},me=function(){try{return Promise.resolve(te.allDocs({include_docs:!0,startkey:"nUTXOKey",endkey:"nUTXOKey￰"})).then((function(e){return e&&e.rows.length>0?{existingNUTXODerivedKeys:e.rows.map((function(e){return e.doc}))}:{existingNUTXODerivedKeys:[]}}))}catch(e){return Promise.reject(e)}},ve=function(e){try{var t=function(){if(e.length>0)return Promise.resolve(me()).then((function(t){var r=t.existingNUTXODerivedKeys.length-1,n=e.map((function(e,t){return e._id||(r+=1),U({},e,{_id:e._id?e._id:"nUTXOKey-"+String(r).padStart(20,"0")})}));return Promise.resolve(te.bulkDocs(n)).then((function(){}))}))}();return Promise.resolve(t&&t.then?t.then((function(){})):void 0)}catch(e){return Promise.reject(e)}},Pe=function(){try{return Promise.resolve(te.allDocs({include_docs:!0,startkey:"key",endkey:"key￰"})).then((function(e){return e&&e.rows.length>0?{existingDerivedKeys:e.rows.map((function(e){return e.doc}))}:{existingDerivedKeys:[]}}))}catch(e){return Promise.reject(e)}},ye=function(e){try{var t=function(){if(e.length>0)return Promise.resolve(Pe()).then((function(t){var r=t.existingDerivedKeys.length-1,n=e.map((function(e,t){return e._id||(r+=1),U({},e,{_id:e._id?e._id:"key-"+String(r).padStart(20,"0")})}));return Promise.resolve(te.bulkDocs(n)).then((function(){}))}))}();return Promise.resolve(t&&t.then?t.then((function(){})):void 0)}catch(e){return Promise.reject(e)}},ge=function(e){try{return Promise.resolve(te.allDocs(U({include_docs:!0},e,{startkey:(null==e?void 0:e.startkey)||"output",endkey:"output￰",skip:!(null==e||!e.startkey)&&1}))).then((function(e){return e&&e.rows.length>0?{nextOutputsCursor:e.rows[e.rows.length-1].id,outputs:e.rows.map((function(e){return e.doc}))}:{nextOutputsCursor:null,outputs:[]}}))}catch(e){return Promise.reject(e)}},xe=function(e){try{var t=function(){return Promise.resolve(te.bulkDocs(r)).then((function(){}))},r=[],n=w(e,(function(t){var n=e[t];return Promise.resolve(te.createIndex({index:{fields:["outputTxHash","outputIndex"]}})).then((function(){return Promise.resolve(te.find({selector:{outputTxHash:{$eq:n.outputTxHash},outputIndex:{$eq:n.outputIndex}}})).then((function(e){if(e.docs.length>0){var t=e.docs.map((function(e){return U({},e,{isSpent:!1})}));r.push.apply(r,t)}}))}))}));return Promise.resolve(n&&n.then?n.then(t):t())}catch(e){return Promise.reject(e)}},Te=function(e){try{var t=function(){if(e.length>0)return Promise.resolve(ge()).then((function(t){var r=t.outputs.length-1,n=e.map((function(e,t){return e._id||(r+=1),U({},e,{isSpent:e.isSpent?e.isSpent:!!e.spendInfo,_id:e._id?e._id:"output-"+String(r).padStart(20,"0")})}));return Promise.resolve(te.bulkDocs(n)).then((function(){}))}))}();return Promise.resolve(t&&t.then?t.then((function(){})):void 0)}catch(e){return Promise.reject(e)}},Ie=function(e){try{var t=function(){return Promise.resolve(te.bulkDocs(r)).then((function(){}))},r=[],n=w(e,(function(t){var n=e[t];return Promise.resolve(te.createIndex({index:{fields:["outputTxHash","outputIndex"]}})).then((function(){return Promise.resolve(te.find({selector:{outputTxHash:{$eq:n.outputTxHash},outputIndex:{$eq:n.outputIndex}}})).then((function(e){if(e.docs.length>0){var t=e.docs.map((function(e){return U({},e,{_deleted:!0})}));r.push.apply(r,t)}}))}))}));return Promise.resolve(n&&n.then?n.then(t):t())}catch(e){return Promise.reject(e)}},_e=function(e){try{return Promise.resolve(te.createIndex({index:{fields:["outputTxHash","outputIndex"]}})).then((function(){return Promise.resolve(te.find({selector:{outputTxHash:{$eq:e.outputTxHash},outputIndex:{$eq:e.outputIndex}}})).then((function(e){return e.docs.length>0}))}))}catch(e){return Promise.reject(e)}},we=function(e){try{return Promise.resolve(te.allDocs(U({include_docs:!0},e,{descending:!0,endkey:"transaction",startkey:(null==e?void 0:e.startkey)||"transaction￰",skip:!(null==e||!e.startkey)&&1}))).then((function(t){return t&&t.rows.length>0?{nextTransactionCursor:t.rows.length===(null==e?void 0:e.limit)?t.rows[t.rows.length-1].id:null,transactions:t.rows.map((function(e){return e.doc}))}:{nextTransactionCursor:null,transactions:[]}}))}catch(e){return Promise.reject(e)}},be=function(e){try{return Promise.resolve(te.createIndex({index:{fields:["confirmation"]}})).then((function(){return Promise.resolve(te.find({selector:{$and:[{confirmation:{$lte:10}},{confirmation:{$exists:!0}}]}})).then((function(e){return e.docs.length>0?{transactions:e.docs}:{transactions:[]}}))}))}catch(e){return Promise.reject(e)}},Se=function(e){try{var t=function(){if(e.length>0)return Promise.resolve(we()).then((function(t){var r=t.transactions.length-1,n=e.reverse().map((function(e,t){return e._id||(r+=1),U({},e,{_id:e._id?e._id:"transaction-"+String(r).padStart(20,"0")})}));return Promise.resolve(te.bulkDocs(n)).then((function(){}))}))}();return Promise.resolve(t&&t.then?t.then((function(){})):void 0)}catch(e){return Promise.reject(e)}},Oe=function(e){try{var t=function(){return b((function(){return Promise.resolve(te.bulkDocs(r)).then((function(e){e.forEach((function(e){if(e.error)throw new Error("Error in updating transactions")}))}))}),(function(e){throw e}))},r=[],n=w(e,(function(t){var n=e[t];return Promise.resolve(te.get(n._id)).then((function(e){r.push(U({},n,{_rev:e._rev,_deleted:!0}))}))}));return Promise.resolve(n&&n.then?n.then(t):t())}catch(e){return Promise.reject(e)}},Ee=function(e){try{var t=function(){if(e.length>0)return Promise.resolve(Pe()).then((function(t){var r=t.existingDerivedKeys.filter((function(t,r){return e.includes(t.address)})).map((function(e,t){return U({},e,{isUsed:!0})}));return Promise.resolve(te.bulkDocs(r)).then((function(){}))}))}();return Promise.resolve(t&&t.then?t.then((function(){})):void 0)}catch(e){return Promise.reject(e)}},Be=function(e){try{return Promise.resolve(te.createIndex({index:{fields:["isSpent","isNameOutpoint"]}})).then((function(){return Promise.resolve(te.find({selector:{isSpent:{$eq:!1},isNameOutpoint:{$exists:!1}}})).then((function(e){return e.docs.length>0?{utxos:e.docs}:{utxos:[]}}))}))}catch(e){return Promise.reject(e)}},ke=function(e){try{return Promise.resolve(te.createIndex({index:{fields:["isSpent","name"]}})).then((function(){return Promise.resolve(te.find({selector:{name:e}})).then((function(e){return e.docs.length>0?{nUTXOs:e.docs[0]}:{nUTXOs:null}}))}))}catch(e){return Promise.reject(e)}},Ne=function(){try{return Promise.resolve(te.createIndex({index:{fields:["isSpent","isNameOutpoint"]}})).then((function(){return Promise.resolve(te.find({selector:{isSpent:{$eq:!1},isNameOutpoint:{$exists:!0}}})).then((function(e){return e.docs.length>0?{names:e.docs.map((function(e){return e.name}))}:{names:[]}}))}))}catch(e){return Promise.reject(e)}},je=function(){try{return Promise.resolve(b((function(){return Promise.resolve(te.viewCleanup()).then((function(){return Promise.resolve(re.destroy()).then((function(){return te=null,re=null,!0}))}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},Ke={__proto__:null,BIP32_EXTENDED_KEY:"bip32ExtendedKey",NUTXO_EXTENDED_KEY:"nUTXOExtendedKey",init:ue,createProfile:se,updateProfile:ce,getProfiles:ae,login:fe,getBip32ExtendedKey:de,setBip32ExtendedKey:he,getNUTXOExtendedKey:pe,setNUTXOExtendedKey:le,getNUTXODerivedKeys:me,upsertNUTXODerivedKeys:ve,getDerivedKeys:Pe,upsertDerivedKeys:ye,getOutputs:ge,markOutputAsUnspent:xe,upsertOutputs:Te,updateOutputs:function(e){try{var t=function(){return b((function(){return Promise.resolve(te.bulkDocs(r)).then((function(e){e.forEach((function(e){if(e.error)throw new Error("Error in updating outputs")}))}))}),(function(e){throw e}))},r=[],n=w(e,(function(t){var n=e[t];return Promise.resolve(te.get(n._id)).then((function(e){r.push(U({},n,{_rev:e._rev}))}))}));return Promise.resolve(n&&n.then?n.then(t):t())}catch(e){return Promise.reject(e)}},deleteOutputs:Ie,isInOutputs:_e,getTransactions:we,getTransactionsByConfirmations:be,upsertTransactions:Se,deleteTransactions:Oe,markAddressesUsed:Ee,getUTXOs:Be,getNUtxo:ke,getUnregisteredName:Ne,destroy:je},Ue=new function(){this.getOutputsByAddress=function(e,t,r){try{return Promise.resolve(b((function(){return Promise.resolve(O("address/"+e+"/outputs",{params:{pagesize:t,cursor:r}})).then((function(e){return e.data}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},this.getOutputsByAddresses=function(e,t,r){try{return Promise.resolve(b((function(){return Promise.resolve(O("addresses/outputs",{params:{address:e,pagesize:t,cursor:r},paramsSerializer:function(e){return m.stringify(e,{arrayFormat:"repeat"})}})).then((function(e){return e.data}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},this.getUTXOsByAddress=function(e,t,r){try{return Promise.resolve(b((function(){return Promise.resolve(O("address/"+e+"/utxos",{params:{pagesize:t,cursor:r}})).then((function(e){return e.data}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},this.getUTXOsByAddresses=function(e,t,r){try{return Promise.resolve(b((function(){return Promise.resolve(O("addresses/utxos",{params:{address:e,pagesize:t,cursor:r},paramsSerializer:function(e){return m.stringify(e,{arrayFormat:"repeat"})}})).then((function(e){return e.data}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}}},Ce=new function(){this.getTransactionByTxID=function(e){try{return Promise.resolve(b((function(){return Promise.resolve(O("transaction/"+e)).then((function(e){return e.data}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},this.getTransactionsByTxIDs=function(e){try{return Promise.resolve(b((function(){return Promise.resolve(O("transactions",{params:{id:e},paramsSerializer:function(e){return m.stringify(e,{arrayFormat:"repeat"})}})).then((function(e){return e.data}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},this.getRawTransactionByTxID=function(e){try{return Promise.resolve(b((function(){return Promise.resolve(O("rawtransaction/"+e)).then((function(e){return e.data}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},this.getRawTransactionsByTxIDs=function(e){try{return Promise.resolve(b((function(){return Promise.resolve(O("rawtransactions",{params:{id:e},paramsSerializer:function(e){return m.stringify(e,{arrayFormat:"repeat"})}})).then((function(e){return e.data}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},this.broadcastRawTransaction=function(e){try{return Promise.resolve(b((function(){return Promise.resolve(E("relaytx",{rawTx:e})).then((function(e){return e.data}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},this.getSpendStatusByOutpoint=function(e){try{return Promise.resolve(b((function(){return Promise.resolve(O("transaction/"+e+"/index/0")).then((function(e){return e.data}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}}},He=new function(){this.getChainInfo=function(){try{return Promise.resolve(b((function(){return Promise.resolve(O("chain/info")).then((function(e){return e.data}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},this.getBlockHeaders=function(e,t){try{return Promise.resolve(b((function(){return Promise.resolve(O("chain/headers",{params:{startBlockHeight:e,pagesize:t}})).then((function(e){return e.data}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}}},Ae=new(function(){function e(){this.mnemonicToSeed=function(e,t){try{return Promise.resolve(s.mnemonicToSeed(e,t))}catch(e){return Promise.reject(e)}},this.getSeedHex=function(e){return e.toString("hex")},this.getBIP32RootKeyFromSeedHex=function(e,t){return n.bip32.fromBase58(e,t)},this.getBIP32RootKeyBase58=function(e){return e.toBase58()},this.getAccountExtendedPrivKey=function(e){return e.toBase58()},this.getAccountExtendedPubKey=function(e){return e.neutered().toBase58()},this.getDerivationPathAccount=function(){var e=g.BITCOIN_SV.BIP44,t="m/";return t+=e.purpose+"'/",(t+=e.coin+"'/")+e.account+"'/"},this.codePointToName=function(e){if(e&&e.length>0){for(var t="",r=0;r<e.length;r++)t+=String.fromCodePoint(e[r]);return t}return null},this.satoshiToBSV=function(e){return e?e/1e8:0}}var t=e.prototype;return t.getCodePoint=function(e){for(var t=[],r=0;r<e.length;r++)t.push(e.codePointAt(r));return t},t.arraysEqual=function(e,t){if(e===t)return!0;if(null==e||null==t)return!1;if(e.length!==t.length)return!1;for(var r=0;r<e.length;++r)if(e[r]!==t[r])return!1;return!0},e}()),De=new(function(){function e(){this.getBIP32ExtendedPrivKey=function(e){var t=n.bip32.fromBase58(e,P.BITCOIN_SV_REGTEST),r="NA";return t.isNeutered()||(r=t.toBase58()),r},this.getBIP32ExtendedPubKey=function(e){return n.bip32.fromBase58(e,P.BITCOIN_SV_REGTEST).neutered().toBase58()}}var t=e.prototype;return t._initWallet=function(e,t){try{var r=this,n=r._mnemonicToSeedSync(e,t),o=r._getBIP32RootKeyFromSeed(n,P.BITCOIN_SV_REGTEST),i=r._getBIP32ExtendedKey(g.BITCOIN_SV_REGTEST.BIP44.derivationPath,o),u=r._getBIP32ExtendedKey(g.BITCOIN_SV_REGTEST.BIP44.nUTXODerivationPath,o);return Promise.resolve(he(i)).then((function(){return Promise.resolve(le(u)).then((function(){return Promise.resolve(Pe()).then((function(e){var t=e.existingDerivedKeys;function n(){return Promise.resolve(me()).then((function(e){var t=e.existingNUTXODerivedKeys,n=r._countOfUnusedKeys(t),o=function(){if(n<20){var e=-1;return t.length>0&&(e=t[t.length-1].indexText.split("/").pop()),Promise.resolve(r.generateDerivedKeys(u,g.BITCOIN_SV_REGTEST.BIP44.nUTXODerivationPath,Number(e)+1,20-n,!1)).then((function(e){return Promise.resolve(ve(e.derivedKeys)).then((function(){}))}))}}();if(o&&o.then)return o.then((function(){}))}))}var o=r._countOfUnusedKeys(t),s=function(){if(o<20){var e=-1;return t.length>0&&(e=t[t.length-1].indexText.split("/").pop()),Promise.resolve(r.generateDerivedKeys(i,g.BITCOIN_SV_REGTEST.BIP44.derivationPath,Number(e)+1,20-o,!1)).then((function(e){return Promise.resolve(ye(e.derivedKeys)).then((function(){}))}))}}();return s&&s.then?s.then(n):n()}))}))}))}catch(e){return Promise.reject(e)}},t._mnemonicToSeedSync=function(e,t){return s.mnemonicToSeedSync(e,t)},t._getBIP32RootKeyFromSeed=function(e,t){return n.bip32.fromSeed(e,t).toBase58()},t._getBIP32ExtendedKey=function(e,t){if(!t)return t;for(var r=n.bip32.fromBase58(t,P.BITCOIN_SV_REGTEST),o=e.split("/"),i=0;i<o.length;i++){var u=o[i],s=parseInt(u);isNaN(s)||(r="'"===u[u.length-1]?r.deriveHardened(s):r.derive(s))}return r.toBase58()},t._generateDerivedKeys=function(e,t,r,o,i,u){var s,c=n.bip32.fromBase58(e,P.BITCOIN_SV_REGTEST);s=u?c.deriveHardened(r):c.derive(r);var a=o,f=n.ECPair.fromPrivateKey(s.privateKey,{network:P.BITCOIN_SV_REGTEST});a&&(f=n.ECPair.fromPrivateKey(s.privateKey,{compressed:!1,network:P.BITCOIN_SV_REGTEST}));var d=t+"/"+r;return u&&(d+="'"),{indexText:d,address:n.payments.p2pkh({pubkey:f.publicKey,network:P.BITCOIN_SV_REGTEST}).address}},t._getPrivKey=function(e,t,r,o,i){var u,s=n.bip32.fromBase58(e,P.BITCOIN_SV_REGTEST);u=i?s.deriveHardened(t):s.derive(t);var c=r,a=n.ECPair.fromPrivateKey(u.privateKey,{network:P.BITCOIN_SV_REGTEST});c&&(a=n.ECPair.fromPrivateKey(u.privateKey,{compressed:!1,network:P.BITCOIN_SV_REGTEST}));var f="";return!u.isNeutered()&&(f=a.toWIF()),{privkey:f}},t.generateDerivedKeys=function(e,t,r,n,o,i,u){try{for(var s=[],c=r;c<r+n;c++){var a=this._generateDerivedKeys(e,t,c,o,i,u);s.push(U({},a,{isUsed:!1}))}return Promise.resolve({derivedKeys:s})}catch(e){return Promise.reject(e)}},t._getAddressesFromKeys=function(e){return e.map((function(e){return e.address}))},t._countOfUnusedKeys=function(e){return e.reduce((function(e,t){return t.isUsed||(e+=1),e}),0)},t._removeDuplicate=function(e){for(var t=e.sort((function(e,t){return(null!==t.blockHeight?t.blockHeight:999999999)-(null!==e.blockHeight?e.blockHeight:999999999)})),r=[],n=0;n<t.length;n++){var o=t[n];if(null!==o.txIndex)break;r.push(o)}if(r.length>0){var i=t.splice(0,2*r.length).filter((function(e,t,r){return t===r.findIndex((function(t){return t.outputTxHash===e.outputTxHash&&t.outputIndex===e.outputIndex}))}));return[].concat(i,t)}return t},t.processAllegoryTransactions=function(e,t){try{var r=function(){return{outputs:e.map((function(e){var t=i.find((function(t){return e.outputTxHash===t.tx.txId&&e.outputIndex===t.index}));return t?U({},e,{name:t.name,isNameOutpoint:!0}):e}))}},n=t.filter((function(e){return!!(e.outputs.length>0&&e.outputs[0].lockingScript.startsWith("006a0f416c6c65676f72792f416c6c506179"))})),o=[];n.forEach((function(e){var t,r=F(Z(e.outputs[0].lockingScript)),n=r.name,i=r.action,u=[];i instanceof H&&i.extensions.length>0&&(u=i.extensions.map((function(e){return e instanceof G?{codePoint:e.codePoint,index:e.producerOutputEx.producer.index}:{codePoint:e.codePoint,index:e.ownerOutputEx.owner.index}})));var s=null===(t=u)||void 0===t?void 0:t.map((function(e){return e.codePoint}));o.push({name:Ae.codePointToName([].concat(n,s)),index:u.length>0?u[0].index:null,tx:e})}));var i=[],u=w(o,(function(e){var t=o[e],r=t.name,n=t.tx.txId,u=function(){if(r){var e=b((function(){return Promise.resolve(E("allegory/name-outpoint",{name:Ae.getCodePoint(r),isProducer:!1})).then((function(e){var o=e.data,u=o.outPoint.opTxHash;Ae.codePointToName(o.forName)===r&&n===u&&i.push(t)}))}),(function(){}));if(e&&e.then)return e.then((function(){}))}}();if(u&&u.then)return u.then((function(){}))}));return Promise.resolve(u&&u.then?u.then(r):r())}catch(e){return Promise.reject(e)}},t.getTransactions=function(e){try{var t=this;return Promise.resolve(Pe()).then((function(r){var n=r.existingDerivedKeys;return Promise.resolve(me()).then((function(r){var o=!1;function i(e){return o?e:{transactions:[]}}var u=[].concat(n,r.existingNUTXODerivedKeys),s=function(){if(u.length>0)return Promise.resolve(t._getOutputs(u)).then((function(r){var n=r.derivedKeys,i=r.nUTXODerivedKeys,u=r.diffOutputs;if(u.length>0){var s=t._removeDuplicate(u),c=[].concat(n,i),a=s.filter((function(e){return!!e.spendInfo})),f=Array.from(new Set(a.map((function(e){return e.spendInfo.spendingTxId})))),d=Array.from(new Set(s.map((function(e){return e.outputTxHash})))),h=Array.from(new Set([].concat(d,f)));return Promise.resolve(t._getTransactions(h)).then((function(r){var u=r.txs;return Promise.resolve(He.getChainInfo()).then((function(r){var a=r.chainInfo;if(a){var f=a.chainTip;if(u.length>0){var d=u.sort((function(e,t){return t.blockHeight-e.blockHeight})).map((function(e){var t=e.tx,r=t.txOuts,n=e.blockHeight,o=t.txInps.map((function(e){var t=c.find((function(t){return t.address===e.address})),r=i.find((function(t){return t.address===e.address}));return{address:e.address,txInputIndex:e.txInputIndex,value:e.value,isMine:!!t,isNUTXO:!!r}})),u=r.map((function(e){var t=c.find((function(t){return t.address===e.address})),r=i.find((function(t){return t.address===e.address}));return{address:e.address,lockingScript:e.lockingScript,outputIndex:e.outputIndex,value:e.value,isMine:!!t,isNUTXO:!!r}}));return U({},{txId:e.txId,inputs:o,outputs:u},{confirmation:n?f-n:null})}));return Promise.resolve(t.processAllegoryTransactions(s,d)).then((function(t){return Promise.resolve(Te(t.outputs)).then((function(){return Promise.resolve(Se(d)).then((function(){return Promise.resolve(ye(n)).then((function(){return Promise.resolve(ve(i)).then((function(){return null!=e&&e.diff?(o=!0,{transactions:d}):(o=!0,Promise.resolve(we(e)))}))}))}))}))}))}throw new Error("Error in fetching transactions")}throw new Error("Error in fetching transactions")}))}))}return null!=e&&e.diff?(o=!0,{transactions:[]}):(o=!0,Promise.resolve(we(e)))}))}();return s&&s.then?s.then(i):i(s)}))}))}catch(e){return Promise.reject(e)}},t._getTransactions=function(e){try{var t=c.chunk(e,20);return Promise.resolve(Promise.all(t.map((function(e){try{return Promise.resolve(Ce.getTransactionsByTxIDs(e))}catch(e){return Promise.reject(e)}})))).then((function(e){return{txs:e.map((function(e){return e.txs})).flat()}}))}catch(e){return Promise.reject(e)}},t._getOutputs=function(e,t,r){void 0===t&&(t=[]),void 0===r&&(r=[]);try{var n=this,o=c.chunk(e,20);return Promise.resolve(Promise.all(o.map((function(e){try{return Promise.resolve(n._getOutputsByAddresses(e))}catch(e){return Promise.reject(e)}})))).then((function(o){var i=o.flat(),u=e.map((function(e){if(!e.isUsed){var t=i.some((function(t){return t.address===e.address}));return U({},e,{isUsed:t})}return e})),s=[].concat(t,i),c=[].concat(r,u),a=c.filter((function(e){return e.indexText.startsWith(g.BITCOIN_SV_REGTEST.BIP44.derivationPath)})),f=c.filter((function(e){return e.indexText.startsWith(g.BITCOIN_SV_REGTEST.BIP44.nUTXODerivationPath)})),d=n._countOfUnusedKeys(a),h=n._countOfUnusedKeys(f);return d<20||h<20?Promise.resolve(de()).then((function(e){var t=a[a.length-1].indexText.split("/").pop();return Promise.resolve(n.generateDerivedKeys(e,g.BITCOIN_SV_REGTEST.BIP44.derivationPath,Number(t)+1,20-d,!1)).then((function(e){var t=e.derivedKeys;return Promise.resolve(pe()).then((function(e){var r=f[f.length-1].indexText.split("/").pop();return Promise.resolve(n.generateDerivedKeys(e,g.BITCOIN_SV_REGTEST.BIP44.nUTXODerivationPath,Number(r)+1,20-h,!1)).then((function(e){var r=[].concat(t,e.derivedKeys);return Promise.resolve(n._getOutputs(r,s,c))}))}))}))})):{diffOutputs:s,derivedKeys:a,nUTXODerivedKeys:f}}))}catch(e){return Promise.reject(e)}},t._getOutputsByAddresses=function(e,t,r){void 0===t&&(t=[]);try{var n=this,o=n._getAddressesFromKeys(e);return Promise.resolve(Ue.getOutputsByAddresses(o,100,r)).then((function(r){return Promise.resolve(ge()).then((function(o){if(o.outputs.length>0)return Promise.resolve(n._getDiffOutputs(r.outputs)).then((function(o){if(o.length===r.outputs.length){var i=[].concat(t,o);return r.nextCursor?Promise.resolve(n._getOutputsByAddresses(e,i,r.nextCursor)):i}return[].concat(t,o)}));var i=[].concat(t,r.outputs);return r.nextCursor?Promise.resolve(n._getOutputsByAddresses(e,i,r.nextCursor)):i}))}))}catch(e){return Promise.reject(e)}},t._getDiffOutputs=function(e){try{var t=!1,r=[],n=w(e,(function(n){return Promise.resolve(_e(e[n])).then((function(o){if(o)return t=!0,r;r.push(e[n])}))}),(function(){return t}));return Promise.resolve(n&&n.then?n.then((function(e){return t?e:r})):t?n:r)}catch(e){return Promise.reject(e)}},t.getUnusedNUTXOAddress=function(){try{return Promise.resolve(me()).then((function(e){return e.existingNUTXODerivedKeys.filter((function(e){return!1===e.isUsed})).map((function(e){return e.address})).find(Boolean)}))}catch(e){return Promise.reject(e)}},t._getKeys=function(e){try{var t=this;return Promise.resolve(Pe()).then((function(r){var o=r.existingDerivedKeys;return Promise.resolve(me()).then((function(r){var i=[].concat(o,r.existingNUTXODerivedKeys);return Promise.resolve(de()).then((function(r){return Promise.resolve(pe()).then((function(o){return e.map((function(e){var u,s=i.find((function(t){return t.address===e}));u=s.indexText.startsWith(g.BITCOIN_SV_REGTEST.BIP44.derivationPath)?r:o;var c=s.indexText.split("/").pop(),a=t._getPrivKey(u,Number(c),!1);return n.ECPair.fromWIF(a.privkey,n.networks.regtest)}))}))}))}))}))}catch(e){return Promise.reject(e)}},t.updateTransactionsConfirmations=function(){try{var e=this;return Promise.resolve(be()).then((function(t){var r=!1,n=t.transactions;function o(e){return r?e:{updatedTransactions:[],deletedTransactions:[]}}var i=n.map((function(e){return e.txId})),u=function(){if(i.length>0)return Promise.resolve(e._getTransactions(i)).then((function(e){var t=e.txs;return function(){if(t.length>0)return Promise.resolve(He.getChainInfo()).then((function(e){var o=e.chainInfo;return function(){if(o){var e=o.chainTip,i=t.map((function(t){var r=t.blockHeight;return U({},t,{confirmation:r?e-r:null})})),u=[],s=[],c=[];return n.forEach((function(e){var t=i.find((function(t){return t.txId===e.txId}));t&&t.confirmation!==e.confirmation?u.push(U({},e,{confirmation:t.confirmation})):null===e.confirmation&&c.push(U({},e))})),Promise.resolve(Se(u)).then((function(){function e(e){return r=!0,{updatedTransactions:u,deletedTransactions:s}}var t=function(){if(c.length>0){var e=function(){return r=!0,{updatedTransactions:u,deletedTransactions:s}},t=w(c,(function(e){var t=c[e],r=a.differenceInMinutes(new Date,Date.parse(t.createdAt)),n=function(){if(r>30){var e=t.inputs.map((function(e){return{outputTxHash:e.outputTxHash,outputIndex:e.txInputIndex}}));return Promise.resolve(xe(e)).then((function(){var e=t.outputs.filter((function(e){return!0===e.isMine})).map((function(e){return{outputTxHash:t.txId,outputIndex:e.outputIndex}}));return Promise.resolve(Ie(e)).then((function(){return s.push(t),Promise.resolve(Oe([t])).then((function(){}))}))}))}}();if(n&&n.then)return n.then((function(){}))}));return t&&t.then?t.then(e):e()}}();return t&&t.then?t.then(e):e()}))}}()}))}()}))}();return u&&u.then?u.then(o):o(u)}))}catch(e){return Promise.reject(e)}},t.relayTx=function(e,t,r,o){try{var i=this,u=t.toHex(),s=Buffer.from(u,"hex").toString("base64");return Promise.resolve(Ce.broadcastRawTransaction(s)).then((function(u){var s=!1,c=u.txBroadcast;function a(e){if(s)return e;throw new Error("Broadcast failed")}var f=function(){if(c){var u=r.map((function(e){return U({},e,{isSpent:!0})})),a=o.map((function(e,r){var o=t.outs.find((function(t,r){if(!Buffer.from(t.script).toString("hex").startsWith("006a0f416c6c65676f72792f416c6c506179")){var o=n.payments.p2pkh({output:t.script,network:P.BITCOIN_SV_REGTEST});return e.address===o.address}return!1})),i=t.outs.findIndex((function(t,r){if(!Buffer.from(t.script).toString("hex").startsWith("006a0f416c6c65676f72792f416c6c506179")){var o=n.payments.p2pkh({output:t.script,network:P.BITCOIN_SV_REGTEST});return e.address===o.address}return!1}));return{address:e.address,isSpent:!1,outputIndex:i,outputTxHash:t.getId(),value:null==o?void 0:o.value}})),f={txId:t.getId(),inputs:t.ins.map((function(t,o){var i,u=n.payments.p2pkh({input:t.script,network:P.BITCOIN_SV_REGTEST}),s=r.find((function(e){return e.outputTxHash===Buffer.from(t.hash).reverse().toString("hex")&&e.outputIndex===t.index}));return{address:u.address,isMine:!!s,isNUTXO:!(!s||!s.isNameOutpoint),txInputIndex:t.index,outputTxHash:Buffer.from(t.hash).reverse().toString("hex"),value:null===(i=e.data.inputs[o].witnessUtxo)||void 0===i?void 0:i.value}})),outputs:t.outs.map((function(e,t){if(Buffer.from(e.script).toString("hex").startsWith("006a0f416c6c65676f72792f416c6c506179"))return{address:null,isMine:!1,isNUTXO:!1,lockingScript:Buffer.from(e.script).toString("hex"),outputIndex:t,value:e.value};var r=n.payments.p2pkh({output:e.script,network:P.BITCOIN_SV_REGTEST}),i=o.find((function(e){return e.address===r.address}));return{address:r.address,isMine:!!i,isNUTXO:!(!i||"nUTXO"!==i.type),lockingScript:Buffer.from(e.script).toString("hex"),outputIndex:t,value:e.value}})),confirmation:null,createdAt:new Date};return Promise.resolve(i.processAllegoryTransactions(a,[f])).then((function(e){var t=e.outputs;return Promise.resolve(i.markAddressesUsed(o.map((function(e){return e.address})))).then((function(){return Promise.resolve(Te(u)).then((function(){return Promise.resolve(Te(t)).then((function(){return Promise.resolve(Se([f])).then((function(){return s=!0,{transaction:f,txBroadcast:c}}))}))}))}))}))}}();return f&&f.then?f.then(a):a(f)}))}catch(e){return Promise.reject(e)}},t._createSendTransaction=function(e,t,r){try{var o=this;return Promise.resolve(b((function(){function u(){var e=c.map((function(e){return e.address}));return Promise.resolve(o._getKeys(e)).then((function(e){e.forEach((function(e,t){f.signInput(t,e)})),f.validateSignaturesOfAllInputs(),f.finalizeAllInputs();var t=f.extractTransaction(!0);return Promise.resolve(o.relayTx(f,t,c,d))}))}var s=i(e,t,r),c=s.inputs,a=s.outputs;if(!c||!a)throw new Error("Empty inputs or outputs");var f=new n.Psbt({network:P.BITCOIN_SV_REGTEST,forkCoin:"bch"});f.setVersion(1),c.forEach((function(e){var t=n.payments.p2pkh({address:e.address,network:P.BITCOIN_SV_REGTEST});f.addInput({hash:e.outputTxHash,index:e.outputIndex,witnessUtxo:{script:t.output,value:e.value}})}));var d=[],h=w(a,(function(e){function t(){f.addOutput({address:r.address,value:r.value})}var r=a[e],n=function(){if(!r.address)return Promise.resolve(o.getUnusedAddresses({excludeAddresses:d})).then((function(e){var t=e.unusedAddresses[0];d.push({type:"",title:"",address:t}),r.address=t}))}();return n&&n.then?n.then(t):t()}));return h&&h.then?h.then(u):u()}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},t.createSendTransaction=function(e,t,r){try{var n=this;return Promise.resolve(Be()).then((function(o){var i=o.utxos,u=[{address:e,value:Number(t)}];return Promise.resolve(n._createSendTransaction(i,u,r))}))}catch(e){return Promise.reject(e)}},t.getTransactionFee=function(e,t,r){try{return Promise.resolve(b((function(){return Promise.resolve(Be()).then((function(n){var o=n.utxos,u=[{address:e,value:Number(t)}];return i(o,u,r).fee}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},t.getBalance=function(){try{return Promise.resolve(ge()).then((function(e){return{balance:e.outputs.reduce((function(e,t){return t.isSpent||(e+=t.value),e}),0)}}))}catch(e){return Promise.reject(e)}},t.generateMnemonic=function(e,t,r){return s.generateMnemonic(e,t,r)},t.getUsedAddresses=function(){try{return Promise.resolve(ge()).then((function(e){for(var t=c.groupBy(e.outputs,(function(e){return e.address})),r=[],n=function(){var e=i[o],t=e[0],n=e[1],u=n.reduce((function(e,t){return t.spendInfo||(e+=t.value),e}),0),s=0,c=0;n.forEach((function(e){e.spendInfo&&(c+=e.value),s+=e.value})),r.push({address:t,incomingBalance:s,outgoingBalance:c,currentBalance:u,lastTransaction:n[0].address})},o=0,i=Object.entries(t);o<i.length;o++)n();return{usedAddresses:r}}))}catch(e){return Promise.reject(e)}},t.getUnusedAddresses=function(e){try{return Promise.resolve(Pe()).then((function(t){var r=t.existingDerivedKeys.filter((function(e){return!1===e.isUsed})).map((function(e){return e.address}));if(null!=e&&e.excludeAddresses){var n=r.filter((function(t){var r;return!(null!==(r=e.excludeAddresses)&&void 0!==r&&r.includes(t))}));return null!=e&&e.count?{unusedAddresses:n.slice(0,e.count)}:{unusedAddresses:n.slice(0,1)}}return null!=e&&e.count?{unusedAddresses:r.slice(0,e.count)}:{unusedAddresses:r.slice(0,1)}}))}catch(e){return Promise.reject(e)}},t.markAddressesUsed=function(e){try{return Promise.resolve(Ee(e)).then((function(){}))}catch(e){return Promise.reject(e)}},t.login=function(e,t){try{var r=this;return Promise.resolve(b((function(){return Promise.resolve(fe(e,t)).then((function(t){return Promise.resolve(ue(e)).then((function(){return Promise.resolve(r._initWallet(t)).then((function(){return{profile:e}}))}))}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},t.createProfile=function(e,t){try{var r=o.encrypt(e,t).toString(),n=u.name.firstName();return localStorage.setItem("currentprofile",n),Promise.resolve(b((function(){return Promise.resolve(se(r,n)).then((function(){return{profile:n}}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},t.updateProfileName=function(e,t){try{return Promise.resolve(b((function(){return Promise.resolve(ce(e,t)).then((function(){return{profile:t}}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},t.getProfiles=function(){try{return Promise.resolve(ae()).then((function(e){return{profiles:e}}))}catch(e){return Promise.reject(e)}},t.getUnregisteredName=function(){try{return Promise.resolve(Ne())}catch(e){return Promise.reject(e)}},t.logout=function(){try{return Promise.resolve(je())}catch(e){return Promise.reject(e)}},t.runScript=function(){try{return Promise.resolve(this._getKeys(["mmFXRtUtKN9znnF9DFgQqvKP5TBHZmgmym"])).then((function(e){console.log(e[0].privateKey.toString("hex"))}))}catch(e){return Promise.reject(e)}},e}()),Re=new(function(){function e(){}var t=e.prototype;return t.buyName=function(e){try{var t=this;return Promise.resolve(b((function(){var r=e.host,n=e.port,o=e.name,u=e.isProducer;return Promise.resolve(Be()).then((function(e){var s=e.utxos,c=[{value:Number(1e6)}],a=i(s,c,0),f=a.inputs;if(!f||!a.outputs)throw new Error("Empty inputs or outputs");var d=f.map((function(e){return[{opTxHash:e.outputTxHash,opIndex:e.outputIndex},e.value]}));return Promise.resolve(De.getUnusedNUTXOAddress()).then((function(e){return Promise.resolve(De.getUnusedAddresses()).then((function(i){var s=i.unusedAddresses[0];if(e&&s)return Promise.resolve(E("partialsign",{paymentInputs:d,name:[o,u],outputOwner:e,outputChange:s},{baseURL:"https://"+r+":"+n+"/v1"})).then((function(r){return Promise.resolve(t.decodeTransaction(r.data.psaTx,f)).then((function(t){return{psbt:t.psbt,outpoint:{name:o,isProducer:u},inputs:f,ownOutputs:[{type:"nUTXO",title:"Name UTXO",address:e},{type:"",title:"",address:s}],snv:!0}}))}));throw new Error("Error configuring input params")}))}))}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},t.decodeTransaction=function(e,t,r){try{var o=JSON.parse(Buffer.from(e,"base64").toString());return Promise.resolve(b((function(){function e(){return o.ins.forEach((function(e,t){if(e.script){var r=n.payments.p2pkh({input:Buffer.from(e.script,"hex"),network:P.BITCOIN_SV_REGTEST});u.updateInput(t,{partialSig:[{pubkey:r.pubkey,signature:r.signature}]})}})),{psbt:u,fundingInputs:s,ownOutputs:c}}var u=new n.Psbt({network:P.BITCOIN_SV_REGTEST,forkCoin:"bch"});u.setVersion(1),o.ins.forEach((function(e){if(e.script){var r=n.payments.p2pkh({input:Buffer.from(e.script,"hex"),network:P.BITCOIN_SV_REGTEST});u.addInput({hash:e.outpoint.hash,index:e.outpoint.index,sequence:e.sequence,witnessUtxo:{script:r.output,value:e.value}})}else{var o=t.find((function(t){return t.outputTxHash===e.outpoint.hash&&t.outputIndex===e.outpoint.index}));if(!o)throw new Error("Error in setting psbt inputs");var i=n.payments.p2pkh({address:o.address,network:P.BITCOIN_SV_REGTEST});u.addInput({hash:e.outpoint.hash,index:e.outpoint.index,sequence:e.sequence,witnessUtxo:{script:i.output,value:o.value}})}}));var s=[],c=[],a=function(){if(r)return Promise.resolve(Be()).then((function(e){var t=e.utxos,r=[{value:Number(1e4)}],a=i(t,r,5e3),f=a.inputs,d=a.outputs;s=f,f.forEach((function(e){var t=n.payments.p2pkh({address:e.address,network:P.BITCOIN_SV_REGTEST});u.addInput({hash:e.outputTxHash,index:e.outputIndex,witnessUtxo:{script:t.output,value:e.value}})})),o.outs.forEach((function(e,t){u.addOutput({script:Buffer.from(e.script,"hex"),value:e.value})}));var h=[],p=w(d,(function(e){function t(){u.addOutput({address:r.address,value:r.value})}var r=d[e],n=function(){if(!r.address)return Promise.resolve(De.getUnusedAddresses({excludeAddresses:h})).then((function(e){var t=e.unusedAddresses[0];h.push(t),r.address=t,c.push({type:"",title:"",address:t})}))}();return n&&n.then?n.then(t):t()}));if(p&&p.then)return p.then((function(){}))}));o.outs.forEach((function(e,t){u.addOutput({script:Buffer.from(e.script,"hex"),value:e.value})}))}();return a&&a.then?a.then(e):e()}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},t.signRelayTransaction=function(e){var t=e.psbtHex,r=e.inputs,o=e.ownOutputs;try{var i=function(e){u.validateSignaturesOfAllInputs(),u.finalizeAllInputs();var t=u.extractTransaction(!0);return Promise.resolve(De.relayTx(u,t,r,o))},u=n.Psbt.fromHex(t,{network:P.BITCOIN_SV_REGTEST,forkCoin:"bch"}),s=0,c=function(e,t,r){for(var n;;){var o=e();if(_(o)&&(o=o.v),!o)return i;if(o.then){n=0;break}var i=r();if(i&&i.then){if(!_(i)){n=1;break}i=i.s}if(t){var u=t();if(u&&u.then&&!_(u)){n=2;break}}}var s=new T,c=I.bind(null,s,2);return(0===n?o.then(f):1===n?i.then(a):u.then(d)).then(void 0,c),s;function a(n){i=n;do{if(t&&(u=t())&&u.then&&!_(u))return void u.then(d).then(void 0,c);if(!(o=e())||_(o)&&!o.v)return void I(s,1,i);if(o.then)return void o.then(f).then(void 0,c);_(i=r())&&(i=i.v)}while(!i||!i.then);i.then(a).then(void 0,c)}function f(e){e?(i=r())&&i.then?i.then(a).then(void 0,c):a(i):I(s,1,i)}function d(){(o=e())?o.then?o.then(f).then(void 0,c):f(o):I(s,1,i)}}((function(){return s<u.data.inputs.length}),(function(){return s++}),(function(){var e=u.data.inputs[s];return function(){if(!e.partialSig){var t=u.txInputs[s],n=r.find((function(e){return e.outputTxHash===Buffer.from(t.hash).reverse().toString("hex")&&e.outputIndex===t.index}));return function(){if(n)return Promise.resolve(De._getKeys([n.address])).then((function(e){e.length>0&&u.signInput(s,e[0])}));throw new Error("Error in signing transaction")}()}}()}));return Promise.resolve(c&&c.then?c.then(i):i())}catch(e){return Promise.reject(e)}},t.verifyRootTx=function(e){try{var t,r=!1,n=this,o=e.psbt,i=e.transaction,u=function(){if(o||i)return o&&(t=Buffer.from(o.txInputs[0].hash).reverse().toString("hex")),i&&(t=i.txInps[0].outpointTxID),"0000000000000000000000000000000000000000000000000000000000000000"===t?(r=!0,!1):"e862d04ac63afa7d3e8118b37d5af0450fab1528016cd39a37cf61c888a198ee"===t?(r=!0,!0):Promise.resolve(Ce.getTransactionByTxID(t)).then((function(e){return r=!0,Promise.resolve(n.verifyRootTx({transaction:e.tx.tx}))}))}();return Promise.resolve(u&&u.then?u.then((function(e){return!!r&&e})):!!r&&u)}catch(e){return Promise.reject(e)}},t.verifyMerkelRoot=function(e){for(var t=e.merkelRoot,r=e.proof,n=e.leafNode;r.length>0;){n=v(v(n).toString()).toString();var o=r.shift();n=n.concat(o)}return t===n},t.getOutpointForName=function(e){try{if(e&&e.length)return Promise.resolve(b((function(){return Promise.resolve(E("allegory/name-outpoint",{name:e,isProducer:!1})).then((function(e){return e.data}))}),(function(e){throw e})));throw new Error("Invalid name error")}catch(e){return Promise.reject(e)}},t.getResellerURI=function(e){try{if(e&&e.length)return Promise.resolve(b((function(){return Promise.resolve(E("allegory/reseller-uri",{name:e,isProducer:!0})).then((function(t){var r=t.data,n=r.uri,o=r.protocol,i=r.isProducer;return Ae.arraysEqual(e,r.forName)&&!0===i?{isAvailable:!1,name:e}:{isAvailable:!0,name:e,uri:n,protocol:o}}))}),(function(e){throw e})));throw new Error("Invalid name error")}catch(e){return Promise.reject(e)}},t.createTransaction=function(e){try{var t=this,r=e.amountInSatoshi,n=e.feeRate;return Promise.resolve(t.getOutpointForName(Ae.getCodePoint(e.allpayName))).then((function(e){return Promise.resolve(Ce.getTransactionByTxID(e.outPoint.opTxHash)).then((function(e){var o=e.tx.tx.txOuts[0].lockingScript,u=F(Z(o)),s=v(o).toString();return Promise.resolve(De.getUnusedAddresses()).then((function(e){var o=e.unusedAddresses[0];return Promise.resolve(Be()).then((function(e){var c=e.utxos,a=[{value:Number(r)}],f=i(c,a,n),d=f.inputs;if(!d||!f.outputs)throw new Error("Empty inputs or outputs");return Promise.resolve(t._createTransaction({proxyHost:"127.0.0.1",proxyPort:8e3,recipient:s,amountInSatoshi:r,changeAddress:o,utxos:d})).then((function(e){var r=e.addressProof,n=e.utxoProof;return Promise.resolve(t.decodeTransaction(e.psaBase64,d)).then((function(e){var i=e.psbt;if(u&&u.action instanceof A){var s=u.action;if(s.oProxyProviders.length>0){var c=Buffer.from(i.txInputs[0].hash).reverse().toString("hex").concat(":").concat(String(i.txInputs[0].index)),a=s.oProxyProviders[0].registration.utxoCommitment;return t.verifyMerkelRoot({leafNode:i.txOutputs[0].address,merkelRoot:s.oProxyProviders[0].registration.addressCommitment,proof:r}),t.verifyMerkelRoot({leafNode:c,merkelRoot:a,proof:n}),{psbt:i,inputs:d,ownOutputs:[{type:"",title:"",address:o}],addressCommitment:!0,utxoCommitment:!0}}}throw Error("Error in drafting Allegory Transaction")}))}))}))}))}))}))}catch(e){return Promise.reject(e)}},t._createTransaction=function(e){try{var t=e.proxyHost,r=e.proxyPort,n=e.recipient,o=e.amountInSatoshi,i=e.changeAddress,u=e.utxos.map((function(e){return[{txid:e.outputTxHash,index:e.outputIndex},Number(e.value)]}));return Promise.resolve(E("ps-allpay-tx",{inputs:u,recipient:n,amount:Number(o),change:i},{baseURL:"http://"+t+":"+r+"/v1"})).then((function(e){var t=e.data;return{psaBase64:t.tx,addressProof:t.addressProof,utxoProof:t.utxoProof}}))}catch(e){return Promise.reject(e)}},t.registerName=function(e){try{var t=this;return Promise.resolve(b((function(){var r=e.proxyHost,n=e.proxyPort,o=e.name,i=e.addressCount,u=Ae.getCodePoint(o);return Promise.resolve(de()).then((function(e){var s=De.getBIP32ExtendedPubKey(e);return Promise.resolve(De.getUnusedNUTXOAddress()).then((function(e){return Promise.resolve(ke(o)).then((function(o){var c=o.nUTXOs;if(c)return Promise.resolve(t._registerName({proxyHost:r,proxyPort:n,name:u,xpubKey:s,returnAddress:e,addressCount:i,nutxo:c})).then((function(r){return Promise.resolve(t.decodeTransaction(r,[c],!0)).then((function(t){var r=t.ownOutputs;return{psbt:t.psbt,inputs:[].concat(c,t.fundingInputs),ownOutputs:[{type:"nUTXO",title:"Name UTXO",address:e}].concat(r)}}))}));throw new Error("Couldn't find utxo for selected name")}))}))}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},t._registerName=function(e){try{var t=e.proxyHost,r=e.proxyPort,n=e.nutxo;return Promise.resolve(E("register",{name:e.name,xpubKey:e.xpubKey,nutxo:[{txid:n.outputTxHash,index:n.outputIndex},n.value],return:e.returnAddress,addressCount:Number(e.addressCount)},{baseURL:"http://"+t+":"+r+"/v1"})).then((function(e){return e.data.tx}))}catch(e){return Promise.reject(e)}},e}()),Xe=new function(){this.login=function(e,t){try{return Promise.resolve(b((function(){return Promise.resolve(E("auth",{username:e,password:t})).then((function(e){return e.data}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}}},Ve=new function(){this.getBlockByBlockHeight=function(e){try{return Promise.resolve(b((function(){return Promise.resolve(O("block/height/"+e)).then((function(e){return e.data}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},this.getBlocksByBlockHeights=function(e){try{return Promise.resolve(b((function(){return Promise.resolve(O("block/heights",{params:{height:e},paramsSerializer:function(e){return m.stringify(e,{arrayFormat:"repeat"})}})).then((function(e){return e.data}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},this.getBlockByBlockHash=function(e){try{return Promise.resolve(b((function(){return Promise.resolve(O("block/hash/"+e)).then((function(e){return e.data}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},this.getBlocksByBlockHashes=function(e){try{return Promise.resolve(b((function(){return Promise.resolve(O("block/hashes",{params:{hash:e},paramsSerializer:function(e){return m.stringify(e,{arrayFormat:"repeat"})}})).then((function(e){return e.data}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},this.getTXIDByHash=function(e,t,r){try{return Promise.resolve(b((function(){return Promise.resolve(O("block/txids/"+e,{params:{pagenumber:t,pagesize:r}})).then((function(e){return e.data}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}}},Ge=new function(){this.getMerkleBranchByTXID=function(e){try{return Promise.resolve(b((function(){return Promise.resolve(O("merklebranch/"+e)).then((function(e){return e.data}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}}},qe=new function(){this.getOutputsByScriptHash=function(e,t){try{return Promise.resolve(b((function(){return Promise.resolve(O("scripthash/"+e+"/outputs",{params:{pagesize:t}})).then((function(e){return e.data}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},this.getOutputsByScriptHashes=function(e){try{return Promise.resolve(b((function(){return Promise.resolve(O("scripthashes/outputs/",{params:{scripthash:e},paramsSerializer:function(e){return m.stringify(e,{arrayFormat:"repeat"})}})).then((function(e){return e.data}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},this.getUTXOsByScriptHash=function(e,t){try{return Promise.resolve(b((function(){return Promise.resolve(O("scripthash/"+e+"/utxos",{params:{pagesize:t}})).then((function(e){return e.data}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},this.getUTXOsByScriptHashes=function(e){try{return Promise.resolve(b((function(){return Promise.resolve(O("scripthashes/utxos",{params:{scripthash:e},paramsSerializer:function(e){return m.stringify(e,{arrayFormat:"repeat"})}})).then((function(e){return e.data}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}}},Me=new function(){this.addUser=function(e,t,r,n){try{return Promise.resolve(b((function(){return Promise.resolve(E("user",{username:e,firstName:t,lastName:r,email:n})).then((function(e){return e.data}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},this.getUser=function(e){try{return Promise.resolve(b((function(){return Promise.resolve(O("user/"+e)).then((function(e){return e.data}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},this.getCurrentUser=function(){try{return Promise.resolve(b((function(){return Promise.resolve(O("user")).then((function(e){return e.data}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},this.updateUser=function(e,t,r,n,o,i,u){try{return Promise.resolve(b((function(){return Promise.resolve(B("user/"+e,{data:{password:t,firstName:r,lastName:n,email:o,apiQuota:i,apiExpiryTime:u.getUTCDate()}})).then((function(e){return e.data}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},this.deleteUser=function(e){try{return Promise.resolve(b((function(){return Promise.resolve(k("user/"+e)).then((function(e){return e.data}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}}};exports.addressAPI=Ue,exports.allPay=Re,exports.allegory=ne,exports.authAPI=Xe,exports.blockAPI=Ve,exports.chainAPI=He,exports.derivationPaths=x,exports.httpClient=N,exports.merkleBranchAPI=Ge,exports.network=y,exports.persist=Ke,exports.scriptHashAPI=qe,exports.transactionAPI=Ce,exports.userAPI=Me,exports.utils=Ae,exports.wallet=De;
//# sourceMappingURL=nipkow-sdk.cjs.production.min.js.map
